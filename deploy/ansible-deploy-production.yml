---
- hosts: lazydevelo.com
  remote_user: "{{ ansible_user }}"
  tasks:
  # Install packages
  - name: ensure git package is at the latest version
    apt: name=git state=latest
  - name: ensure virtualenv package is at the latest version
    apt: name=virtualenv state=latest
  - name: ensure nginx package is at the latest version
    apt: name=nginx state=latest
  - name: ensure supervisor package is at the latest version
    apt: name=supervisor state=latest
  - name: update homepage git repo to latest master (HEAD) version from github
    git: repo=https://github.com/axper/homepage.git dest=/srv/http/homepage version=HEAD
  # Deploy
  - name: copy django secret key to server
    copy: content="{{ django_secret_key }}" dest=/srv/http/homepage/deploy/django_secret_key.txt mode=0600
  - name: create virtualenv
    pip: virtualenv=/root/.virtualenvs/homepage requirements=/srv/http/homepage/deploy/requirements.txt
  - name: django collect static files
    django_manage: virtualenv=/root/.virtualenvs/homepage app_path=/srv/http/homepage command=collectstatic
  - name: django migrate
    django_manage: virtualenv=/root/.virtualenvs/homepage app_path=/srv/http/homepage command=migrate
  - name: remove default nginx site
    file: path=/etc/nginx/sites-enabled/default state=absent
  - name: link django production config
    file:
      src: /srv/http/homepage/homepage/settings/available/production.conf
      dest: /srv/http/homepage/homepage/settings/components/production.conf
      state: link
  - name: link nginx.conf to nginx's config dir in /etc
    file: src=/srv/http/homepage/deploy/nginx.conf dest=/etc/nginx/sites-enabled/homepage.conf state=link
  - name: link supervisor.conf to supervisor's config dir in /etc
    file: src=/srv/http/homepage/deploy/supervisor.conf dest=/etc/supervisor/conf.d/homepage.conf state=link
  # Restart web servers
  - name: start and enable supervisor service
    service: name=supervisor state=started enabled=yes
  - name: restart gunicorn program in supervisor
    supervisorctl: name=gunicorn state=restarted
  - name: restart and enable nginx service
    service: name=nginx state=restarted enabled=yes
